@*
    MTD OrderMaker - http://ordermaker.org
    Copyright (c) 2019 Oleg Bruev <job4bruev@gmail.com>. All rights reserved.

    This file is part of MTD OrderMaker.
    MTD OrderMaker is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see  https://www.gnu.org/licenses/.
*@
@page
@model EditModel
@using Microsoft.AspNetCore.Mvc.Localization
@inject IHtmlLocalizer<SharedResource> Localizer
@{
    ViewData["Title"] = Localizer["Policy editor"];
    ViewData["SecondTitle"] = Localizer["Editing access level"];
    ViewData["policyId"] = HttpContext.Request.Query["id"];
}

@section Head {
    <link rel="stylesheet" href="~/lib/mtd-ordermaker/store/css/mtd-store-edit.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/mtd-ordermaker/users/css/mtd-users-rights.css" asp-append-version="true" />
}

@section Action {
    <li class="mdc-list-item" role="menuitem" onclick="document.getElementById('all').click()">
        <span class="mdc-list-item__graphic material-icons" aria-hidden="true">done_all</span>
        <span class="mdc-list-item__text">@Localizer["Select all"]</span>
    </li>
    <li class="mdc-list-item" role="menuitem" onclick="document.getElementById('clear').click()">
        <span class="mdc-list-item__graphic material-icons" aria-hidden="true">select_all</span>
        <span class="mdc-list-item__text">@Localizer["Unselect all"]</span>
    </li>
    <li role="separator" class="mdc-list-divider"></li>
    <li id="policy-open-dialog" class="mdc-list-item" role="menuitem">
        <span class="mdc-list-item__graphic material-icons" aria-hidden="true">delete</span>
        <span class="mdc-list-item__text">@Localizer["Delete policy"]</span>
    </li>
}

@section Breadcrumb {
    <li><a href="/Identity/Users">@Localizer["Users"]</a></li>
    <li><a href="/Identity/Users/Policy">@Localizer["Policies"]</a></li>
    <li>@ViewData["Title"]</li>
}

<form mtd-data-form method="post" enctype="multipart/form-data" action="/api/policy/all">
    @Html.AntiForgeryToken()
    <input name="policy-id" type="hidden" value="@Model.MtdPolicy.Id" />
    <input id="all" mtd-data-clicker type="hidden" />
</form>

<form mtd-data-form method="post" enctype="multipart/form-data" action="/api/policy/clear">
    @Html.AntiForgeryToken()
    <input name="policy-id" type="hidden" value="@Model.MtdPolicy.Id" />
    <input id="clear" mtd-data-clicker type="hidden" />
</form>

<form mtd-data-form method="post" action="/api/policy/edit" enctype="multipart/form-data">
    <input type="hidden" name="policy-id" value="@Model.MtdPolicy.Id" />
    @Html.AntiForgeryToken()
    <div class="mtd-desk">
        <div class="mtd-store-edit-bar" style="text-align: right">
            <div class="mtd-store-edit-control" style="position:absolute">
                <a mtd-data-clicker class="mdc-fab mdc-fab--extended" aria-label="Save">
                    <span class="material-icons mdc-fab__icon">save</span>
                    <span class="mdc-fab__label">@Localizer["Save"]</span>
                </a>
            </div>
            <div>
                <button mtd-data-href="/identity/users/policy" class="mdc-button" type="button">
                    <span class="mdc-button__label">@Localizer["Cancel"]</span>
                    <i class="material-icons mdc-button__icon" aria-hidden="true">cancel</i>
                </button>
            </div>
        </div>
        <div style="display:flex; padding: 8px; flex-wrap: wrap">
            <div style="display: flex; flex-direction: column; flex-grow: 1">
                <div class="mdc-text-field mdc-text-field--outlined" style="width: 100%; max-width: 600px; margin-top: 16px;">
                    <input type="text" id="tf-outlined" mtd-required="config-form-name" class="mdc-text-field__input" name="policy-name" asp-for="MtdPolicy.Name" required />
                    <div class="mdc-notched-outline">
                        <div class="mdc-notched-outline__leading"></div>
                        <div class="mdc-notched-outline__notch">
                            <label for="tf-outlined" class="mdc-floating-label">@Localizer["Name"]</label>
                        </div>
                        <div class="mdc-notched-outline__trailing"></div>
                    </div>
                </div>
                <div class="mdc-text-field-helper-line">
                    <div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg" aria-hidden="true">
                        @Localizer["Required field"]
                    </div>
                </div>
                <div class="mdc-text-field mdc-text-field--textarea" style="width: 100%; max-width:600px; margin-top: 16px;">
                    <textarea id="textarea" mtd-required="config-form-description" class="mdc-text-field__input" rows="3" cols="40" name="policy-note" asp-for="MtdPolicy.Description" required></textarea>
                    <div class="mdc-notched-outline">
                        <div class="mdc-notched-outline__leading"></div>
                        <div class="mdc-notched-outline__notch">
                            <label for="textarea" class="mdc-floating-label">@Localizer["Description"]</label>
                        </div>
                        <div class="mdc-notched-outline__trailing"></div>
                    </div>
                </div>
                <div class="mdc-text-field-helper-line">
                    <div class="mdc-text-field-helper-text mdc-text-field-helper-text--validation-msg" aria-hidden="true">
                        @Localizer["Required field"]
                    </div>
                </div>
            </div>
        </div>
        <div class="mtd-users-rights-place">
            <div class="mtd-users-rights-wrapper">
                <table style="font-size: smaller">
                    <thead>
                        <tr>
                            <th rowspan="2">
                                @Localizer["Form name"]
                            </th>
                            <th colspan="7">@Localizer["Rights"]</th>
                        </tr>
                        <tr>
                            <th>
                                @Localizer["Create"]
                            </th>
                            <th>
                                @Localizer["View"]
                            </th>
                            <th>
                                @Localizer["Edit"]
                            </th>
                            <th>
                                @Localizer["Delete"]
                            </th>
                            <th>
                                @Localizer["Set Owner"]
                            </th>
                            <th>
                                @Localizer["Reviewer"]
                            </th>
                            <th>
                                @Localizer["Set Date"]
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var form in Model.MtdForms)
                        {
                            <tr>
                                <td mtd-rights="@form.Id" style="cursor: pointer">
                                    <i id="@form.Id-icon" class="material-icons">
                                        add_box
                                    </i>
                                    <span class="mtd-users-rights-formname">@form.Name</span>
                                </td>
                                <td>
                                    @{
                                        bool checkCreate = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.Create == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-create" name="@form.Id-create" @if (checkCreate) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @{
                                        bool checkView = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.ViewAll == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-view" name="@form.Id-view" @if (checkView) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                        <label for="@form.Id-view">@Localizer["All"]</label>
                                    </div>
                                    @{
                                        bool checkViewGroup = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.ViewGroup == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-view-group" name="@form.Id-view-group" @if (checkViewGroup) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                        <label for="@form.Id-view-group">@Localizer["Group"]</label>
                                    </div>
                                    @{
                                        bool checkViewOwn = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.ViewOwn == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-view-own" name="@form.Id-view-own" @if (checkViewOwn) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                        <label for="@form.Id-view-own">@Localizer["Only own"]</label>
                                    </div>
                                </td>
                                <td>
                                    @{
                                        bool checkEdit = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.EditAll == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-edit" name="@form.Id-edit" @if (checkEdit) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                        <label for="@form.Id-edit">@Localizer["All"]</label>
                                    </div>
                                    @{
                                        bool checkEditGroup = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.EditGroup == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-edit-group" name="@form.Id-edit-group" @if (checkEditGroup) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                        <label for="@form.Id-edit-group">@Localizer["Group"]</label>
                                    </div>
                                    @{
                                        bool checkEditOwn = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.EditOwn == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-edit-own" name="@form.Id-edit-own" @if (checkEditOwn) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                        <label for="@form.Id-edit-own">@Localizer["Only own"]</label>
                                    </div>
                                </td>
                                <td>
                                    @{
                                        bool checkDelete = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.DeleteAll == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-delete" name="@form.Id-delete" @if (checkDelete) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                        <label for="@form.Id-delete">@Localizer["All"]</label>
                                    </div>
                                    @{
                                        bool checkDeleteGroup = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.DeleteGroup == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-delete-group" name="@form.Id-delete-group" @if (checkDeleteGroup) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                        <label for="@form.Id-delete-group">@Localizer["Group"]</label>
                                    </div>
                                    @{
                                        bool checkDeleteOwn = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.DeleteOwn == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-delete-own" name="@form.Id-delete-own" @if (checkDeleteOwn) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                        <label for="@form.Id-delete-own">@Localizer["Only own"]</label>
                                    </div>
                                </td>
                                <td>
                                    @{
                                        bool setOwner = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.ChangeOwner == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-set-own" name="@form.Id-set-own" @if (setOwner) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @{
                                        bool review = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.Reviewer == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-reviewer" name="@form.Id-reviewer" @if (review) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @{
                                        bool setDate = Model.MtdPolicy.MtdPolicyForms.Where(x => x.MtdForm == form.Id && x.ChangeDate == 1).Any();
                                    }
                                    <div class="mdc-form-field">
                                        <div class="mdc-checkbox">
                                            <input type="checkbox"
                                                   class="mdc-checkbox__native-control"
                                                   id="@form.Id-set-date" name="@form.Id-set-date" @if (setDate) { <text> checked</text>} />
                                            <div class="mdc-checkbox__background">
                                                <svg class="mdc-checkbox__checkmark"
                                                     viewBox="0 0 24 24">
                                                    <path class="mdc-checkbox__checkmark-path"
                                                          fill="none"
                                                          d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                </svg>
                                                <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>

                            foreach (var part in form.MtdFormPart.OrderBy(x => x.Sequence))
                            {
                                <tr mtd-rights-parts="@part.Id" mtd-rights-parent="@form.Id" style="display: none">
                                    <td>&nbsp;&nbsp;&nbsp;&nbsp;@part.Name</td>
                                    <td>
                                        @{
                                            bool checkPartCreate = Model.MtdPolicy.MtdPolicyParts.Where(x => x.MtdFormPart == part.Id && x.Create == 1).Any();
                                        }
                                        <div class="mdc-form-field">
                                            <div class="mdc-checkbox">
                                                <input type="checkbox"
                                                       class="mdc-checkbox__native-control"
                                                       id="@part.Id-part-create" name="@part.Id-part-create" @if (checkPartCreate) { <text> checked</text>} />
                                                <div class="mdc-checkbox__background">
                                                    <svg class="mdc-checkbox__checkmark"
                                                         viewBox="0 0 24 24">
                                                        <path class="mdc-checkbox__checkmark-path"
                                                              fill="none"
                                                              d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                    </svg>
                                                    <div class="mdc-checkbox__mixedmark"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        @{
                                            bool checkPartView = Model.MtdPolicy.MtdPolicyParts.Where(x => x.MtdFormPart == part.Id && x.View == 1).Any();
                                        }
                                        <div class="mdc-form-field">
                                            <div class="mdc-checkbox">
                                                <input type="checkbox"
                                                       class="mdc-checkbox__native-control"
                                                       id="@part.Id-part-view" name="@part.Id-part-view" @if (checkPartView) { <text> checked</text>} />
                                                <div class="mdc-checkbox__background">
                                                    <svg class="mdc-checkbox__checkmark"
                                                         viewBox="0 0 24 24">
                                                        <path class="mdc-checkbox__checkmark-path"
                                                              fill="none"
                                                              d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                    </svg>
                                                    <div class="mdc-checkbox__mixedmark"></div>
                                                </div>
                                            </div>
                                            <label for="@part.Id-part-view"></label>
                                        </div>
                                    </td>
                                    <td>
                                        @{
                                            bool checkPartEdit = Model.MtdPolicy.MtdPolicyParts.Where(x => x.MtdFormPart == part.Id && x.Edit == 1).Any();
                                        }
                                        <div class="mdc-form-field">
                                            <div class="mdc-checkbox">
                                                <input type="checkbox"
                                                       class="mdc-checkbox__native-control"
                                                       id="@part.Id-part-edit" name="@part.Id-part-edit" @if (checkPartEdit) { <text> checked</text>} />
                                                <div class="mdc-checkbox__background">
                                                    <svg class="mdc-checkbox__checkmark"
                                                         viewBox="0 0 24 24">
                                                        <path class="mdc-checkbox__checkmark-path"
                                                              fill="none"
                                                              d="M1.73,12.91 8.1,19.28 22.79,4.59" />
                                                    </svg>
                                                    <div class="mdc-checkbox__mixedmark"></div>
                                                </div>
                                            </div>
                                            <label for="@part.Id-part-edit"></label>
                                        </div>
                                    </td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</form>

<form mtd-data-form method="post" autocomplete='off' enctype='multipart/form-data' action='/api/policy/delete'>
    @Html.AntiForgeryToken()
    <input id="policy-delete-id" name="policy-delete-id" type="hidden" value="@ViewBag.PolicyId" />
    <input id="deleteClicker" mtd-data-clicker mtd-data-location="/identity/users/policy" type="hidden" />
</form>

<div id="dialog-policy-delete" class="mdc-dialog"
     role="alertdialog"
     aria-modal="true"
     aria-labelledby="my-dialog-title"
     aria-describedby="my-dialog-content">
    <div class="mdc-dialog__container">
        <div class="mdc-dialog__surface">
            <h2 class="mdc-dialog__title" id="delete-dialog-title">
                @Localizer["Delete policy"]?
            </h2>
            <div class="mdc-dialog__content" id="delete-dialog-content">
                @Localizer["The policy will be permanently deleted"].
            </div>
            <footer class="mdc-dialog__actions">
                <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="no">
                    <span class="mdc-button__label">@Localizer["Cancel"]</span>
                </button>
                <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="yes">
                    <span class="mdc-button__label" onclick="document.getElementById('deleteClicker').click();">@Localizer["Delete"]</span>
                </button>
            </footer>
        </div>
    </div>
    <div class="mdc-dialog__scrim"></div>
</div>

@section Scripts{
    <script src="~/lib/mtd-ordermaker/users/js/mtd-user-rights.js" asp-append-version="true"></script>
}
